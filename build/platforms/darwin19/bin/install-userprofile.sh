#!/bin/bash

CONFIGUREPLUS_ZERO_ARG_BASENAME=$(basename $0)

if [[ ! "$CONFIGUREPLUS_DEBUG" ]]; then

    CONFIGUREPLUS_DEBUG=

fi

# functions

function warn_local
{
    if [ "$CONFIGUREPLUS_DEBUG" ]; then

        >&2 echo "[WARN stdout, $CONFIGUREPLUS_ZERO_ARG_BASENAME] : {" $@ "}" 

    fi
}

source .configureplus/currentsession.bash

CONFIGUREPLUS_LINETAG="$CONFIGURE_PKGNAME/$CONFIGUREPLUS_VERSION/$CONFIGUREPLUS_SESSION"

warn_local "CONFIGUREPLUS_OBJECT=$CONFIGUREPLUS_OBJECT"

warn_local "CHECK if configureplus is present in ${CONFIGURE_BASH_PROFILE_FILE}"

warn_local grep $CONFIGUREPLUS_LINETAG $CONFIGURE_BASH_PROFILE_FILE

FLAG_PRESENT=$(grep $CONFIGUREPLUS_LINETAG $CONFIGURE_BASH_PROFILE_FILE)

if [[ "$FLAG_PRESENT" ]]; then

    warn_local "$CONFIGURE_PKGNAME SETUP PRESENT in ${CONFIGURE_BASH_PROFILE_FILE}"

else

    warn_local "$CONFIGURE_PKGNAME SETUP NOT FOUND in ${CONFIGURE_BASH_PROFILE_FILE}"

    CONFIGURE_BASH_PROFILE_FILE_BAK=${CONFIGURE_MKTEMP}/backup/${CONFIGURE_BASH_PROFILE_FILE}.bak

    warn_local "CREATE userprofile copy to ${CONFIGURE_BASH_PROFILE_FILE_BAK}"

    warn_local mkdir -p $(dirname $CONFIGURE_BASH_PROFILE_FILE_BAK)

    mkdir -p $(dirname $CONFIGURE_BASH_PROFILE_FILE_BAK)

    warn_local CONFIGUREPLUS_LINETAG=$CONFIGUREPLUS_LINETAG
    
    cp $CONFIGURE_BASH_PROFILE_FILE $CONFIGURE_BASH_PROFILE_FILE_BAK

    CONFIGURE_BASH_PROFILE_FILE_BAK=$CONFIGURE_BASH_PROFILE_FILE
    
    CONFIGUREPLUS_SESSION_HOME=$CONFIGUREPLUS_DIR_CONFIG/$CONFIGUREPLUS_DIR_OUT/session/$CONFIGUREPLUS_SESSION

    USERPROFILE_FILE=$CONFIGUREPLUS_SESSION_HOME/userprofile.bash

    echo "" >>${CONFIGURE_BASH_PROFILE_FILE_BAK}
    echo "## BEGIN $CONFIGURE_PKGNAME INSTALLATION # $CONFIGUREPLUS_LINETAG" >>${CONFIGURE_BASH_PROFILE_FILE_BAK}
    echo "export CONFIGUREPLUS_INSTALL_TIMESTAMP='"$(date)"'" "# $CONFIGUREPLUS_LINETAG" >>${CONFIGURE_BASH_PROFILE_FILE_BAK}
    echo "source $CONFIGUREPLUS_SESSION_HOME/userprofile.bash" "# $CONFIGUREPLUS_LINETAG" >>${CONFIGURE_BASH_PROFILE_FILE_BAK}
    echo "## END"" # $CONFIGUREPLUS_LINETAG" >>${CONFIGURE_BASH_PROFILE_FILE_BAK}

    grep -v $CONFIGUREPLUS_LINETAG $CONFIGURE_BASH_PROFILE_FILE_BAK >${CONFIGURE_BASH_PROFILE_FILE_BAK}.cleaned
    
fi

